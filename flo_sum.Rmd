---
title: "Flow summaries"
author: "Marcus Beck"
output: 
  html_document:
    code_folding: show
self_contained: yes
---

```{r, echo = F}
library(knitr)
opts_chunk$set(warning = FALSE, message = FALSE, fig.path = 'figs/')
```

```{r}
library(tidyverse)
library(knitr)
library(english)

# load data
data(shed)
data(flos)

# long format with separate variables for categories
head(flos)
```

```{r}
# catchment stream length
lns <- flos %>% 
  select(SMC_Name, COMID, Shape_Leng) %>% 
  unique %>% 
  group_by(SMC_Name) %>% 
  summarise(totlen = sum(Shape_Leng))

# splits
flcts <- c(1, 10, 100)
dicts <- c(0.1, 0.9)
flos <- flos %>% 
  mutate(
    flocat = cut(flo, breaks = c(-Inf, flcts, Inf), labels = c('< 1 cfs', '1 - 10 cfs', '10 - 100 cfs', '> 100 cfs')),
    dicat = cut(Di, breaks = c(-Inf, dicts, Inf), labels = c('Inflated', 'Stable', 'Diminished'))
  ) %>% 
  left_join(lns, by = 'SMC_Name') %>% 
  mutate(
    SMC_Name = factor(SMC_Name, 
                      levels = c('San Gabriel', 'Lower Santa Ana', 'Middle Santa Ana', 'Upper Santa Ana', 'San Jacinto'), 
                      labels = c('SGB', 'LSA', 'MSA', 'USA', 'SJC')
                      ), 
    mo = factor(mo, levels = c('Oct', 'Nov', 'Dec', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep'))
  )
  

# summarize by flocat
sum1 <- flos %>% 
  group_by(SMC_Name, mo, clim, flocat) %>% 
  summarise(
    len = sum(Shape_Leng), 
    lenper = len / unique(totlen)
    )

# summarize by flocat, dicat
sum2 <- flos %>% 
  group_by(SMC_Name, mo, clim, dicat) %>% 
  summarise(
    len = sum(Shape_Leng),
    lenper = len / unique(totlen)
    )

save(sum1, file = 'data/sum1.RData', compress = 'xz') 
save(sum2, file = 'data/sum2.RData', compress = 'xz') 
head(sum1)
head(sum2)
```

```{r refplot, fig.height = 8, fig.width = 7}
ggplot(data = sum1, aes(x = clim, y = len)) + 
  geom_bar(aes(fill = flocat), stat = "identity", position = "stack") + 
  scale_fill_brewer(palette = "Blues", name = "Discharge") + 
  facet_grid(mo~SMC_Name) + xlab("") + ylab("Total stream-length (km)") + 
  ggtitle("Reference flows") + 
  theme(legend.position = "bottom")
```

```{r anthroplot, fig.height = 8, fig.width = 7}
ggplot(data = sum2, aes(x = clim, y = len)) +
  geom_bar(aes(fill = dicat), stat = "identity", position = "stack")+
  scale_fill_manual(values = c("#91cf60","#91bfdb","#fc8d59"), name = "Likely change\nin discharge") + 
  facet_grid(mo~SMC_Name) + xlab("") + ylab("Total stream-length (km)") + 
  ggtitle("Anthropogenic flow") + 
  theme(legend.position = "bottom")
```


Modelled flow estimates from `r flos$COMID %>% unique %>% length` stream reaches in `r flos$SMC_Name %>% unique %>% length %>% english` catchments in Southern California were summarized to quantify stream miles under different hydrologic conditions. Flow estimates were based on reference scenarios under historical, non-impacted land use conditions and anthropogenic scenarios under current, developed conditions.  For each condition, monthly flow was estimated for climate variation characterized as dry, normal, and wet years.  Likelihood of flow conditions inflating, diminishing, or remaining stable was also summarized for each watershed.

Among all watersheds, flow estimates under reference conditions were highest during winter to early spring (January through April) when flows > 100 cfs were more common. Similarly, flows < 1 cfs were more common during the summer and fall.  A general gradient of decreasing flow from the upper to lower catchments was also observed.  For example, flow estimates for the Upper Santa Ana catchment were generally higher than those for the Lower Santa Ana.  Flow estimates also increased as expected under different climate conditions such that greater flow was estimated during wet years.  Diminishing flow was the most common prediction under anthropogenic conditions, although some exceptions were observed.  Stream reaches were more likely to remain stable during the winter, particularly in December. Flow conditions were also more likely to be stable during wet years.   Interestingly, stream conditions in January under normal precipitation were most likely to be inflated, whereas conditions were expected to be stable during wet years. Patterns between catchments were generally consistent.      
